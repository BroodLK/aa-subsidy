{% extends 'contracts/base.html' %}
{% load i18n humanize static %}

{% block details %}
<div class="container-xxl py-3">
  <div id="loadingOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:2000;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);" class="text-center">
      <div class="spinner-border text-light" role="status" aria-hidden="true"></div>
      <div class="mt-2 text-light small">{% trans "Loading…" %}</div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="m-0" id="contractsHeader">{% trans "Contracts Dashboard" %}</h3>
      <div class="d-flex align-items-center gap-2">
        <select id="globalFitSelector" class="form-select form-select-sm d-none"></select>
      </div>
    </div>

    <div class="card-body p-2">
      <div class="table-responsive">
        <table id="contractsTable" class="table table-sm align-middle mb-0 table-bordered">
          <thead class="table-dark">
            <tr class="text-center">
              <th data-col="id">{% trans "ID" %}</th>
              <th data-col="issuer">{% trans "Issuer" %}</th>
              <th data-col="date_issued">{% trans "Date Issued" %}</th>
              <th data-col="price_listed">{% trans "Price Listed" %}</th>
              <th data-col="status">{% trans "Status" %}</th>
              <th data-col="title">{% trans "Title" %}</th>
              <th data-col="station">{% trans "Station" %}</th>
              <th data-col="doctrine">{% trans "Doctrine" %}</th>
              <th data-col="review_status">{% trans "Review_Status" %}</th>
              <th data-col="subsidy_amount">{% trans "Subsidy_Amount" %}</th>
              <th data-col="reason">{% trans "Reason" %}</th>
              <th data-col="paid">{% trans "Paid" %}</th>
              <th data-col="pct_jita">% Jita</th>
              <th data-col="actions">{% trans "Actions" %}</th>
              <th class="text-center">
                <span class="d-none d-md-inline">{% trans "Select" %}</span>
              </th>
            </tr>
            <tr class="text-center small">
              <th><input class="form-control form-control-sm" data-filter="id" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="issuer" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="date_issued" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="price_listed" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="status">
                  <option value="">{% trans "All" %}</option>
                  <option>outstanding</option>
                  <option>finished</option>
                  <option>deleted</option>
                  <option>failed</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="title" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="station" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="doctrine" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="review_status">
                  <option value="">{% trans "All" %}</option>
                  <option>Approved</option>
                  <option>Rejected</option>
                  <option>Pending</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="subsidy_amount" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="reason" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="paid">
                  <option value="">{% trans "All" %}</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="pct_jita" placeholder="…"></th>
              <th></th>
              <th class="text-center">
                <input type="checkbox" id="bulkCheckAll" class="form-check-input">
              </th>
            </tr>
          </thead>
          <tbody>
            {% for row in contracts %}
            <tr class="text-center contract-row" data-id="{{ row.id }}" style="cursor: pointer;">
              <td data-val="{{ row.id }}">{{ row.id }}</td>
              <td data-val="{{ row.issuer }}">
                <span class="copyable" data-copy="{{ row.issuer }}" title="{% trans 'Click to copy' %}">
                  <i class="fa fa-copy ms-1 text-secondary"></i> {{ row.issuer }}
                </span>
              </td>
              <td data-val="{{ row.date_issued }}">{{ row.date_issued }}</td>
              <td data-val="{{ row.price_listed }}">{{ row.price_listed|intcomma }}</td>
              <td data-val="{{ row.status|lower }}">{{ row.status|title }}</td>
              <td data-val="{{ row.title|default_if_none:''|escape }}">{{ row.title|escape }}</td>
              <td data-val="{{ row.station|default_if_none:''|escape }}">
                {% if row.station %}
                  <i class="fa fa-location-dot text-info" data-bs-toggle="tooltip" title="{{ row.station|escape }}"></i>
                {% else %}—{% endif %}
              </td>
              <td data-val="{{ row.doctrine|striptags }}">
                  <div class="d-flex flex-column gap-1">
                    <div class="doctrine-display">{{ row.doctrine|safe|default:"—" }}</div>
                    <div class="d-flex align-items-center gap-1 force-fit-container d-none">
                      <select class="form-select form-select-sm force-fit-select" data-contract="{{ row.id }}">
                        <option value="__clear__">{% trans "Chose a doctrine" %}</option>
                        <option value="__clear__">{% trans "Clear choice" %}</option>
                        {% for f in all_fits %}
                          <option value="{{ f.id }}">{{ f.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
              </td>
              <td data-val="{{ row.review_status }}">
                <span class="{% if row.review_status == 'Approved' %}text-success{% elif row.review_status == 'Rejected' %}text-danger{% endif %}">{{ row.review_status }}</span>
              </td>
              <td data-val="{{ row.subsidy_amount }}" data-suggested="{{ row.suggested_subsidy|default_if_none:'' }}" data-basis="{{ row.basis_isk|default_if_none:'' }}">
                <div class="input-group input-group-sm">
                  <input type="number" step="0.01" class="form-control form-control-sm themable-input text-end"
                         value="{{ row.subsidy_amount|default_if_none:0|floatformat:2 }}"
                         data-id="{{ row.id }}" data-field="subsidy_amount">
                  <button class="btn btn-outline-secondary copy-btn" type="button" title="{% trans 'Copy subsidy' %}" data-copy-target="[data-field='subsidy_amount'][data-id='{{ row.id }}']">
                    <i class="fa fa-copy"></i>
                  </button>
                </div>
              </td>
              <td data-val="{{ row.reason|default_if_none:''|escape }}">
                {% if row.reason %}
                  <i class="fa fa-comment text-info" data-bs-toggle="tooltip" title="{{ row.reason|escape }}"></i>
                {% else %}—{% endif %}
              </td>
              <td data-val="{{ row.paid|yesno:'Yes,No' }}">
                <span class="{% if row.paid %}text-success{% endif %}">{{ row.paid|yesno:"Yes,No" }}</span>
              </td>
              <td data-val="{{ row.pct_jita }}" data-basis="{{ row.basis_isk|default_if_none:'' }}" data-price="{{ row.price_listed|default_if_none:'' }}"
                class="{% if row.pct_jita > 101 %}text-danger{% elif row.pct_jita < 99 %}text-warning{% else %}text-success{% endif %}">{{ row.pct_jita|default_if_none:0|floatformat:2 }}%
              </td>
              <td>
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-success" data-id="{{ row.id }}" data-action="approve" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %} title="{% trans 'Approve' %}">
                    <i class="fa fa-check text-success me-1"></i><span class="d-none d-md-inline">{% trans "Approve" %}</span>
                  </button>
                  <button class="btn btn-outline-warning" data-id="{{ row.id }}" data-action="approve_with_comment" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %} title="{% trans 'Approve + Comment' %}">
                    <i class="fa fa-check-double text-warning me-1"></i><span class="d-none d-md-inline">{% trans "Approve + Comment" %}</span>
                  </button>
                  <button class="btn btn-outline-danger" data-id="{{ row.id }}" data-action="deny" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %} title="{% trans 'Deny' %}">
                    <i class="fa fa-x text-danger me-1"></i><span class="d-none d-md-inline">{% trans "Deny" %}</span>
                  </button>
                </div>
              </td>
              <td class="text-center align-middle">
                <input type="checkbox" class="form-check-input bulk-row-check" data-id="{{ row.id }}">
              </td>
            </tr>
            <tr id="details-{{ row.id }}" class="detail-row">
              <td colspan="15" class="bg-dark p-3">
                <div class="card bg-secondary text-light">
                  <div class="card-header border-light py-1">
                    <h6 class="m-0 small">{% trans "Contract Items" %}</h6>
                  </div>
                  <div class="card-body p-0">
                    <div class="items-container" data-id="{{ row.id }}">
                      <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="15" class="text-center text-muted">{% trans "No contracts to display." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="small text-muted">
          <span id="bulkSelectedCount">0</span> {% trans "selected" %}
        </div>
        <div class="btn-group btn-group-sm" role="group">
          <button id="bulkApprove" type="button" class="btn btn-outline-success" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}>
            <i class="fa fa-check text-success me-1"></i>{% trans "Approve Selected" %}
          </button>
          <button id="bulkApproveWithComment" type="button" class="btn btn-outline-warning" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}>
            <i class="fa fa-check-double text-warning me-1"></i>{% trans "Approve + Comment Selected" %}
          </button>
          <button id="bulkDeny" type="button" class="btn btn-outline-danger" {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}>
            <i class="fa fa-x text-danger me-1"></i>{% trans "Deny Selected" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="post" action="" id="approvalModalForm">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="approvalModalLabel">{% trans "Item Action" %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modalAction" name="action" value="">
            <input type="hidden" id="modalContractId" name="contract_id" value="">
            <input type="hidden" id="modalSubsidyAmount" name="subsidy_amount" value="">
            <div class="mb-3">
              <label for="commentText" class="form-label">{% trans "Reason/Comment" %}</label>
              <textarea id="commentText" name="comment" class="form-control themable-input" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
            <button type="submit" class="btn btn-primary">{% trans "Confirm" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
  <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        {% trans "Copied to clipboard" %}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
    </div>
  </div>
</div>

<style>
  .container-xxl { max-width: 100%; }
  .copyable { cursor: pointer; }
  th[data-col] { cursor: pointer; }
  .contract-row { cursor: pointer; }
  .detail-row { display: none; }
  .detail-row.show { display: table-row; }
  .detail-row.collapsing { display: table-row; }
</style>
<script>
    window.AASubsidyConfig = {
        contractItemsUrl: "{% url 'aasubsidy:contract_items' 0 %}",
        saveTablePrefUrl: "{% url 'aasubsidy:save_table_pref' %}",
        forceFitUrl: "{% url 'aasubsidy:force_fit' 0 %}",
        approveUrl: "{% url 'aasubsidy:approve' 0 %}",
        denyUrl: "{% url 'aasubsidy:deny' 0 %}",
        tablePref: {{ table_pref|default:"null"|safe }},
        isAuthenticated: {{ request.user.is_authenticated|yesno:'true,false' }},
        lang: {
            denyWithReason: "{% trans 'Deny with Reason' %}",
            approveWithComment: "{% trans 'Approve with Comment' %}",
            selectAtLeastOne: "{% trans 'Select at least one row.' %}",
            enterComment: "{% trans 'Enter comment (optional):' %}",
            enterReason: "{% trans 'Enter reason for denial (required):' %}",
            reasonRequired: "{% trans 'Reason is required.' %}"
        }
    };
</script>
<script src="{% static 'aasubsidy/js/review.js' %}"></script>
{% endblock %}