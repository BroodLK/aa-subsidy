{% extends 'contracts/base.html' %}
{% load i18n humanize static %}

{% block details %}
<div class="container-xxl py-3">
    <div id="loadingOverlay" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:2000;">
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);" class="text-center">
        <div class="spinner-border text-light" role="status" aria-hidden="true"></div>
        <div class="mt-2 text-light small">{% trans "Loadingâ€¦" %}</div>
      </div>
    </div>
    {% for system in systems %}
    <div id="stockSection_{{ forloop.index }}" class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="m-0" id="stockHeader_{{ forloop.index }}">{{ system.system_name }}</h3>
        </div>
        <div class="card-body p-2">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0 table-bordered">
                    <thead class="table-dark">
                    <tr class="text-center">
                        <th>{% trans "Doctrine" %}</th>
                        <th>{% trans "Stock Requested" %}</th>
                        <th>{% trans "Stock Available" %}</th>
                        <th>{% trans "Stock Needed" %}</th>
                        <th>{% trans "Volume (m3)" %}</th>
                        <th>{% trans "Jita Sell (ISK)" %}</th>
                        <th>{% trans "Subsidy Amount (ISK)" %}</th>
                        <th>{% trans "Alliance Purchase (ISK)" %}</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for r in system.rows %}
                    <tr>
                        <td><a href="/fittings/fit/{{ r.fit_id }}/" target="_blank">{{ r.fitting_name }}</a></td>
                        <td class="text-end">{{ r.stock_requested|intcomma }}</td>
                        <td class="text-end
                            {% if r.stock_available > r.stock_requested %} text-success
                            {% elif r.stock_available < r.stock_requested %} text-danger
                            {% else %}{% endif %}">
                            {{ r.stock_available|intcomma }}
                        </td>
                        <td class="text-end">
                            {% with needed=r.stock_needed adj=r.adjusted_needed %}
                                {% if needed > 0 %}
                                    <a href="#"
                                       class="claim-link {% if r.claimed_total|default:0 > 0 %}text-warning{% else %}text-danger{% endif %}"
                                       data-bs-toggle="modal"
                                       data-bs-target="#claimModal"
                                       data-fit-id="{{ r.fit_id }}"
                                       data-fit-name="{{ r.doctrine }}"
                                       data-available="{{ r.stock_available }}"
                                       data-needed="{{ needed }}"
                                       data-claimed-total="{{ r.claimed_total }}"
                                       data-claimed-me="{{ r.claimed_by_me }}"
                                       data-claimants="{% if r.claimants %}{{ r.claimants }}{% endif %}"
                                       data-bs-html="true"
                                       data-bs-placement="top"
                                       title=""
                                       data-bs-original-title=""
                                       data-bs-toggle="tooltip"
                                       data-bs-title="<div class='fw-semibold mb-1'>{{ r.doctrine }}</div>"
                                       data-bs-content="<div>Stock available: <span class='fw-semibold'>{{ r.stock_available|intcomma }}</span></div><div>Stock being brought by you: <span class='fw-semibold'>{{ r.claimed_by_me|intcomma }}</span></div>">
                                        {{ adj|intcomma }}
                                    </a>
                                {% else %}
                                    <span class="text-muted">{{ adj|intcomma }}</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="text-end">{{ r.volume_m3|intcomma }}</td>
                        <td class="text-end">
                            {{ r.jita_sell_isk|intcomma }}
                            <span class="copyable" data-copy="{{ r.jita_sell_isk }}" title="{% trans 'Click to copy' %}">
                                <i class="fa fa-copy ms-1 text-secondary"></i>
                            </span>
                        </td>
                        <td class="text-end">{{ r.subsidy_isk|intcomma }}</td>
                        <td class="text-end">{{ r.alliance_purchase_isk|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">{% trans "No doctrines to display for this system." %}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                    <tfoot>
                      <tr class="table-dark">
                        <th class="text-end">{% trans "Totals" %}</th>
                        <th class="text-end">{{ system.totals.requested|intcomma }}</th>
                        <th class="text-end">{{ system.totals.available|intcomma }}</th>
                        <th class="text-end">{{ system.totals.needed|intcomma }}</th>
                        <th colspan="4"></th>
                      </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="card mb-4">
        <div class="card-body text-center text-muted">
            {% trans "No doctrine systems defined or active." %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="claimModal" tabindex="-1" aria-labelledby="claimModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="claimForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="claimModalLabel">{% trans "Claim Supply" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small" id="claimFitName"></div>
        <label for="claimQty" class="form-label">{% trans "How many items are you claiming to supply" %}</label>
        <input type="number" min="0" step="1" class="form-control" id="claimQty" required>
        <input type="hidden" id="claimFitId">
        <div class="form-text" id="claimHint"></div>
        <div class="invalid-feedback d-block" id="claimError" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger me-auto d-none" id="clearClaimBtn">{% trans "Clear my claim" %}</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
  <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        {% trans "Copied to clipboard" %}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{% trans 'Close' %}"></button>
    </div>
  </div>
</div>

<script>
    window.AASubsidyConfig = {
        deleteClaimUrl: "{% url 'aasubsidy:delete_claim' %}",
        saveClaimUrl: "{% url 'aasubsidy:save_claim' %}"
    };
</script>
<script src="{% static 'aasubsidy/js/summary.js' %}"></script>
{% endblock %}