{% extends 'contracts/base.html' %}
{% load i18n humanize static %}

{% block details %}
<div class="container-xxl py-3">
  <div id="stockSection" class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="m-0 d-none" id="contractsHeader">{% trans "Contracts Dashboard" %}</h3>
        <h3 class="m-0" id="stockHeader">{% trans "Doctrine Stock Summary" %}</h3>
      </div>
    <div class="card-body p-2">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0 table-bordered">
          <thead class="table-dark">
            <tr class="text-center">
              <th>{% trans "Doctrine" %}</th>
              <th>{% trans "Stock Requested" %}</th>
              <th>{% trans "Stock Available" %}</th>
              <th>{% trans "Stock Needed" %}</th>
              <th>{% trans "Volume (m3)" %}</th>
              <th>{% trans "Jita Sell (ISK)" %}</th>
              <th>{% trans "Subsidy Amount (ISK)" %}</th>
              <th>{% trans "Alliance Purchase (ISK)" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ r.doctrine }}</td>
              <td class="text-end">{{ r.stock_requested|intcomma }}</td>
              <td class="text-end">{{ r.stock_available|intcomma }}</td>
              <td class="text-end">{{ r.stock_needed|intcomma }}</td>
              <td class="text-end">{{ r.volume_m3|floatformat:2 }}</td>
              <td class="text-end">{{ r.jita_sell_isk|intcomma }}</td>
              <td class="text-end">{{ r.subsidy_isk|intcomma }}</td>
              <td class="text-end">{{ r.alliance_purchase_isk|intcomma }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="8" class="text-center text-muted">{% trans "No doctrines to display." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="contractsSection" class="d-none card">
    <div class="card-body p-2">
      <div class="table-responsive">
        <table id="contractsTable" class="table table-sm align-middle mb-0 table-bordered">
          <thead class="table-dark">
            <tr class="text-center">
              <th data-col="id">{% trans "ID" %}</th>
              <th data-col="issuer">{% trans "Issuer" %}</th>
              <th data-col="date_issued">{% trans "Date Issued" %}</th>
              <th data-col="price_listed">{% trans "Price Listed" %}</th>
              <th data-col="status">{% trans "Status" %}</th>
              <th data-col="title">{% trans "Title" %}</th>
              <th data-col="station">{% trans "Station" %}</th>
              <th data-col="doctrine">{% trans "Doctrine" %}</th>
              <th data-col="review_status">{% trans "Review_Status" %}</th>
              <th data-col="subsidy_amount">{% trans "Subsidy_Amount" %}</th>
              <th data-col="reason">{% trans "Reason" %}</th>
              <th data-col="paid">{% trans "Paid" %}</th>
              <th data-col="pct_jita">% Jita</th>
              <th data-col="actions">{% trans "Actions" %}</th>
            </tr>
            <tr class="text-center small">
              <th><input class="form-control form-control-sm" data-filter="id" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="issuer" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="date_issued" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="price_listed" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="status">
                  <option value="">{% trans "All" %}</option>
                  <option>outstanding</option>
                  <option>finished</option>
                  <option>deleted</option>
                  <option>failed</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="title" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="station" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="doctrine" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="review_status">
                  <option value="">{% trans "All" %}</option>
                  <option>Approved</option>
                  <option>Rejected</option>
                  <option>Pending</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="subsidy_amount" placeholder="…"></th>
              <th><input class="form-control form-control-sm" data-filter="reason" placeholder="…"></th>
              <th>
                <select class="form-select form-select-sm" data-filter="paid">
                  <option value="">{% trans "All" %}</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </th>
              <th><input class="form-control form-control-sm" data-filter="pct_jita" placeholder="…"></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for row in contracts %}
            <tr class="text-center {% if row.review_status == 'Approved' %}border-success{% elif row.review_status == 'Rejected' %}border-danger{% endif %}">
              <td data-val="{{ row.id }}">{{ row.id }}</td>
              <td data-val="{{ row.issuer }}">
                <span class="copyable" data-copy="{{ row.issuer }}" title="{% trans 'Click to copy' %}">
                  <i class="fa fa-copy ms-1 text-secondary"></i> {{ row.issuer }}
                </span>
              </td>
              <td data-val="{{ row.date_issued }}">{{ row.date_issued }}</td>
              <td data-val="{{ row.price_listed }}">{{ row.price_listed|intcomma }}</td>
              <td data-val="{{ row.status|lower }}">{{ row.status|title }}</td>
              <td data-val="{{ row.title|default_if_none:''|escape }}">{{ row.title|escape }}</td>
              <td data-val="{{ row.station|default_if_none:''|escape }}">
                {% if row.station %}
                  <i class="fa fa-location-dot text-info" data-bs-toggle="tooltip" title="{{ row.station|escape }}"></i>
                {% else %}—{% endif %}
              </td>
              <td data-val="{{ row.doctrine|striptags|escape }}">{{ row.doctrine|safe }}</td>
              <td data-val="{{ row.review_status }}">{{ row.review_status }}</td>
              <td data-val="{{ row.subsidy_amount }}">
                <div class="input-group input-group-sm">
                  <input type="number" step="0.01" class="form-control form-control-sm themable-input text-end"
                         value="{{ row.subsidy_amount|floatformat:2 }}"
                         data-id="{{ row.id }}" data-field="subsidy_amount">
                  <button class="btn btn-outline-secondary copy-btn" type="button" title="{% trans 'Copy subsidy' %}" data-copy-target="[data-field='subsidy_amount'][data-id='{{ row.id }}']">
                    <i class="fa fa-copy"></i>
                  </button>
                </div>
              </td>
              <td data-val="{{ row.reason|default_if_none:''|escape }}">
                {% if row.reason %}
                  <i class="fa fa-comment text-info" data-bs-toggle="tooltip" title="{{ row.reason|escape }}"></i>
                {% else %}—{% endif %}
              </td>
              <td data-val="{{ row.paid|yesno:'Yes,No' }}">{{ row.paid|yesno:"Yes,No" }}</td>
              <td data-val="{{ row.pct_jita }}">{{ row.pct_jita|floatformat:2 }}</td>
              <td data-val="">
                <div class="btn-group btn-group-sm" role="group">
                  <button class="btn btn-outline-success"
                          data-id="{{ row.id }}"
                          data-action="approve"
                          {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}
                          title="{% trans 'Approve' %}">
                    <i class="fa fa-check text-success me-1"></i>
                    <span class="d-none d-md-inline">{% trans "Approve" %}</span>
                  </button>
                  <button class="btn btn-outline-warning"
                          data-id="{{ row.id }}"
                          data-action="approve_with_comment"
                          {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}
                          title="{% trans 'Approve + Comment' %}">
                    <i class="fa fa-check-double text-warning me-1"></i>
                    <span class="d-none d-md-inline">{% trans "Approve + Comment" %}</span>
                  </button>
                  <button class="btn btn-outline-danger"
                          data-id="{{ row.id }}"
                          data-action="deny"
                          {% if not perms.aasubsidy.review_subsidy %}disabled{% endif %}
                          title="{% trans 'Deny' %}">
                    <i class="fa fa-x text-danger me-1"></i>
                    <span class="d-none d-md-inline">{% trans "Deny" %}</span>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="14" class="text-center text-muted">{% trans "No contracts to display." %}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="" id="approvalModalForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="approvalModalLabel">{% trans "Item Action" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="modalAction" name="action" value="">
          <input type="hidden" id="modalContractId" name="contract_id" value="">
          <input type="hidden" id="modalSubsidyAmount" name="subsidy_amount" value="">
          <div class="mb-3">
            <label for="commentText" class="form-label">{% trans "Reason/Comment" %}</label>
            <textarea id="commentText" name="comment" class="form-control themable-input" rows="3" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="submit" class="btn btn-primary">{% trans "Confirm" %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .container-xxl { max-width: 100%; }
  .copyable { cursor: pointer; }
  th[data-col] { cursor: pointer; }
</style>

<script>
    window.AASubsidyConfig = {
        saveTablePrefUrl: "{% url 'aasubsidy:save_table_pref' %}",
        approveUrl: "{% url 'aasubsidy:approve' 0 %}",
        denyUrl: "{% url 'aasubsidy:deny' 0 %}",
        tablePref: {{ table_pref|default:"null"|safe }},
        isAuthenticated: {{ request.user.is_authenticated|yesno:'true,false' }},
        lang: {
            denyWithReason: "{% trans 'Deny with Reason' %}",
            approveWithComment: "{% trans 'Approve with Comment' %}"
        }
    };
</script>
<script src="{% static 'aasubsidy/js/dashboard.js' %}"></script>
{% endblock %}
